<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <title>–û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html"><b>BIAS TRAINER</b></a>
      <div class="d-flex ms-auto align-items-center">
        <select id="languageSelect" class="form-select" style="width:auto">
          <option value="ru">üá∑üá∫ RU</option>
          <option value="en">üá¨üáß Eng</option>
        </select>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div id="bias-content" class="col-12 col-lg-6 bias-article">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const biasContentEl = document.getElementById('bias-content');
    const languageSelect = document.getElementById('languageSelect');
    const htmlTag = document.documentElement;

    const locale = localStorage.getItem('lang') || 'ru';
    htmlTag.lang = locale;
    languageSelect.value = locale;

    const texts = {
      ru: { notFound: '–ò—Å–∫–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.', missing: '–ù–µ —É–∫–∞–∑–∞–Ω BIAS ID.', error: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.',
        examples: '–ü—Ä–∏–º–µ—Ä—ã', details: '–ü–æ–¥—Ä–æ–±–Ω–µ–µ', advices: '–°–æ–≤–µ—Ç—ã', wiki: '–°—Ç–∞—Ç—å—è –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏' },
      en: { notFound: 'Bias not found.', missing: 'BIAS ID is missing.', error: 'Failed to load data.',
        examples: 'Examples', details: 'Details', advices: 'Tips', wiki: 'Wikipedia article' }
    };

    const localeMap = { ru: 'ru-RU', en: 'en-US' };
    const defaultApiLocale = 'ru-RU';
    const apiBase = 'https://cdn.contentful.com/spaces/bczf5h4ng6uk/environments/master/entries';
    const token = 'byZhanM7gUzErkI8Kv2Vxq8UfwiRdLcwDEOANav8K7g';

    languageSelect.addEventListener('change', () => {
      localStorage.setItem('lang', languageSelect.value);
      location.reload();
    });

    const biasId = +new URLSearchParams(location.search).get('biasId');
    if (!biasId) {
      biasContentEl.innerHTML = `<p class="text-danger">${texts[locale].missing}</p>`;
      throw new Error('biasId missing');
    }

    const richTextToString = (rt) => {
      if (typeof rt === 'string') return rt;
      const out = [];
      (rt?.content || []).forEach(block => {
        const text = (block?.content || [])
          .map(child => child?.value || '')
          .join('')
          .trim();
        if (text) out.push(text);
      });
      return out.join('\n\n');
    };

    const normalizeArray = (value) => {
      if (Array.isArray(value)) return value;
      return value ? [value] : [];
    };

    const normalizeBias = (item) => {
      const f = item?.fields || {};
      const content = f.content || {};
      const engTitle = content.engTitle || f.engTitle || '';
      const title = locale === 'en' ? (engTitle || f.title || '') : (f.title || engTitle || '');
      return {
        biasId: Number(f.biasId) || null,
        title,
        shortDescription: f.shortDescription || content.shortDescription || '',
        category: f.category || content.category || '',
        fullDescription: richTextToString(f.fullDescription || content.fullDescription || ''),
        content: {
          engTitle,
          advices: normalizeArray(content.advices || f.advices),
          examples: normalizeArray(content.examples || f.examples),
          questions: normalizeArray(content.questions || f.questions),
          wikipediaLink: content.wikipediaLink || f.wikipediaLink
        },
        wikipediaLink: content.wikipediaLink || f.wikipediaLink
      };
    };

    const renderBias = (bias) => {
      const trueId = bias.biasId ? bias.biasId - 100 : '';
      const title = bias.title;
      const shortDes = bias.shortDescription || '';
      const fullDes = bias.fullDescription || '';
      const cat = bias.category || '';
      const { engTitle, examples = [], advices = [] } = bias.content ?? {};

      let imgTag = '';
      if (engTitle && engTitle.trim()) {
        const imgSrc = 'img/' + encodeURIComponent(engTitle.trim()) + '.png';
        imgTag = `<img src="${imgSrc}" alt="${title}"
                        class="article-img mb-4"
                        onerror="this.style.display='none'">`;
      }

      let html = `
        ${imgTag}
        <h1 class="mb-3">${trueId}. ${title}</h1>
        ${cat ? `<span class="badge mb-3">${cat}</span>` : ''}
        ${shortDes ? `<p class="fs-5 mb-4">${shortDes}</p>` : ''}`;

      if (examples.length) {
        html += `<h3 class="mt-3">${texts[locale].examples}</h3><ul>`;
        examples.forEach(e => html += `<li>${e}</li>`);
        html += '</ul>';
      }

      const paragraphs = fullDes
        .split(/\n{2,}/)
        .filter(Boolean)
        .map(p => `<p>${p.trim()}</p>`)
        .join('');
      if (paragraphs) {
        html += `<h3 class="mt-4">${texts[locale].details}</h3>` + paragraphs;
      }

      if (advices.length) {
        html += `<h3 class="mt-4">${texts[locale].advices}</h3><ul>`;
        advices.forEach(a => html += `<li>${a}</li>`);
        html += '</ul>';
      }

      if (bias.wikipediaLink) {
        const linkText = texts[locale].wiki;
        html += `<p class="mt-4"><a href="${bias.wikipediaLink}" target="_blank" rel="noopener">${linkText}</a></p>`;
      }

      biasContentEl.innerHTML = html;
    };

    const fetchEntries = (langCode) => {
      const apiLocale = localeMap[langCode] || defaultApiLocale;
      const apiUrl = `${apiBase}?access_token=${token}&locale=${apiLocale}&limit=1000`;
      return fetch(apiUrl).then(r => r.json()).then(j => j.items || []);
    };

    (async () => {
      try {
        let items = await fetchEntries(locale);
        if (!items.length && locale !== 'ru') {
          items = await fetchEntries('ru');
        }

        const biases = items.map(normalizeBias).filter(b => b.biasId);
        const bias = biases.find(b => b.biasId === biasId);
        if (!bias) {
          biasContentEl.innerHTML = `<p class="text-danger">${texts[locale].notFound}</p>`;
          return;
        }
        renderBias(bias);
      } catch (err) {
        console.error(err);
        biasContentEl.innerHTML = `<p class="text-danger">${texts[locale].error}</p>`;
      }
    })();
  </script>
</body>

</html>
