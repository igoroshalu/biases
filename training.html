<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Тренировка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="style.css" rel="stylesheet" />
</head>
<body class="quiz-body">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">Когнитивные искажения</a>
      <div class="d-flex ms-auto align-items-center">
        <select id="languageSelect" class="form-select" style="width:auto">
          <option value="ru">Русский</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-8">
        <h1 class="mb-4" id="pageTitle">Тренировка</h1>

        <div id="quiz" class="quiz-card card p-4 shadow-sm">
          <p id="questionText" class="fs-5 mb-3">...</p>

          <div id="answers" class="mt-2 vstack gap-3" role="group" aria-label="Варианты ответа"></div>

          <div id="explanation" class="explanation d-none mt-3" aria-live="polite"></div>

          <button id="nextBtn" class="btn btn-next btn-gradient w-100 mt-3 d-none">
            Следующий вопрос
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- i18n ---
  const languageSelect = document.getElementById('languageSelect');
  const locale = localStorage.getItem('lang') || 'ru';
  languageSelect.value = locale;
  document.documentElement.lang = locale;

  const localeMap = { ru: 'ru-RU', en: 'en-US' };
  const defaultApiLocale = 'ru-RU';
  const apiBase = 'https://cdn.contentful.com/spaces/bczf5h4ng6uk/environments/master/entries';
  const token   = 'byZhanM7gUzErkI8Kv2Vxq8UfwiRdLcwDEOANav8K7g';

  const texts = {
    ru: {
      brand: 'Когнитивные искажения',
      title: 'Тренировка',
      next: 'Следующий вопрос',
      loadError: 'Ошибка загрузки данных.',
      explanation: 'Пояснение',
      linkToBias: 'Перейти к искажению'
    },
    en: {
      brand: 'Cognitive biases',
      title: 'Training',
      next: 'Next question',
      loadError: 'Failed to load data.',
      explanation: 'Explanation',
      linkToBias: 'Open bias page'
    }
  };

  function applyTexts() {
    const t = texts[locale];
    document.querySelector('.navbar-brand').textContent = t.brand;
    document.getElementById('pageTitle').textContent = t.title;
    document.getElementById('nextBtn').textContent = t.next;
  }
  applyTexts();

  languageSelect.addEventListener('change', () => {
    localStorage.setItem('lang', languageSelect.value);
    location.reload();
  });

  // --- Загрузка данных из Contentful ---
  const richTextToString = (rt) => {
    if (typeof rt === 'string') return rt;
    const out = [];
    (rt?.content || []).forEach(block => {
      const text = (block?.content || [])
        .map(child => child?.value || '')
        .join('')
        .trim();
      if (text) out.push(text);
    });
    return out.join('\n\n');
  };

  const normalizeArray = (value) => {
    if (Array.isArray(value)) return value;
    return value ? [value] : [];
  };

  const normalizeBias = (item) => {
    const f = item?.fields || {};
    const content = f.content || {};
    const engTitle = content.engTitle || f.engTitle || '';
    const title = locale === 'en' ? (engTitle || f.title || '') : (f.title || engTitle || '');
    return {
      biasId: Number(f.biasId) || null,
      title,
      shortDescription: f.shortDescription || content.shortDescription || '',
      category: f.category || content.category || '',
      fullDescription: richTextToString(f.fullDescription || content.fullDescription || ''),
      content: {
        engTitle,
        advices: normalizeArray(content.advices || f.advices),
        examples: normalizeArray(content.examples || f.examples),
        questions: normalizeArray(content.questions || f.questions),
        wikipediaLink: content.wikipediaLink || f.wikipediaLink
      },
      wikipediaLink: content.wikipediaLink || f.wikipediaLink
    };
  };

  const fetchEntries = (langCode) => {
    const apiLocale = localeMap[langCode] || defaultApiLocale;
    const apiUrl = `${apiBase}?access_token=${token}&locale=${apiLocale}&limit=1000`;
    return fetch(apiUrl, { cache: 'no-store' })
      .then(r => r.json())
      .then(j => j.items || []);
  };

  async function getBiases() {
    const cacheKey = `biasData_v2_${locale}`;
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      try { return JSON.parse(cached); } catch { localStorage.removeItem(cacheKey); }
    }

    let items = [];
    try {
      items = await fetchEntries(locale);
      if (!items.length && locale !== 'ru') {
        items = await fetchEntries('ru');
      }
    } catch (e) {
      if (locale !== 'ru') {
        items = await fetchEntries('ru');
      } else {
        throw e;
      }
    }

    const data = Array.isArray(items) ? items.map(normalizeBias).filter(b => b.biasId) : [];
    if (data.length) {
      localStorage.setItem(cacheKey, JSON.stringify(data));
    }
    return data;
  }

  // --- DOM ---
  const questionText = document.getElementById('questionText');
  const answersEl    = document.getElementById('answers');
  const nextBtn      = document.getElementById('nextBtn');
  const explanationEl= document.getElementById('explanation');

  // --- Helpers ---
  const norm = s => (s ?? '')
    .toString()
    .replace(/\u00A0/g, ' ')       // nbsp -> space
    .replace(/\s+/g, ' ')          // collapse spaces
    .trim();

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function restartAnimation(node, cls) {
    node.classList.remove(cls);
    void node.offsetWidth;
    node.classList.add(cls);
  }

  // --- Состояние ---
  let biases = [];
  let questions = [];
  let current = null; // { text, explanation, title, biasId }

  function buildQuestions(data) {
    questions = [];
    data.forEach(b => {
      const qs = b?.content?.questions;
      if (!qs) return;
      const arr = Array.isArray(qs) ? qs : [qs];
      arr.forEach(q => {
        const text = typeof q === 'string' ? q : (q?.text ?? '');
        const explanation = typeof q === 'object' ? (q?.answerExplanation ?? '') : '';
        if (text && b?.title) {
          questions.push({
            text: text.trim(),
            explanation: (explanation || '').trim(),
            title: b.title,
            biasId: b.biasId
          });
        }
      });
    });
  }

  function showQuestion() {
    nextBtn.classList.add('d-none');
    explanationEl.classList.add('d-none');
    explanationEl.innerHTML = '';
    answersEl.innerHTML = '';

    current = questions[Math.floor(Math.random() * questions.length)];
    if (!current) {
      questionText.textContent = texts[locale].loadError;
      return;
    }

    questionText.textContent = current.text;
    restartAnimation(questionText, 'fade-in');

    const others = shuffle(biases.filter(b => b.title !== current.title));
    const options = shuffle([current.title, ...others.slice(0, 3).map(b => b.title)]);

    options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn answer-btn btn-gradient w-100 fade-in';
      btn.textContent = opt;
      btn.dataset.value = opt;                 // <- сравниваем по data-атрибуту
      btn.style.animationDelay = `${i * 120}ms`;
      btn.onclick = () => checkAnswer(btn.dataset.value, btn);
      answersEl.appendChild(btn);
    });
  }

  function checkAnswer(answer, clickedBtn) {
    const isCorrect = norm(answer) === norm(current.title);

    Array.from(answersEl.children).forEach(b => {
      b.disabled = true;
      // Полная очистка состояний
      b.classList.remove('btn-gradient','answer-correct','answer-wrong','answer-dim','celebrate','pop','shake');

      if (norm(b.dataset.value) === norm(current.title)) {
        b.classList.add('answer-correct');       // правильный — зелёный
      } else if (b === clickedBtn && !isCorrect) {
        b.classList.add('answer-wrong');         // выбранный неправильный — КРАСНЫЙ
      } else {
        b.classList.add('answer-dim');           // остальные — минималистичные
      }
    });

    // Анимации выбранной кнопки
    if (isCorrect) {
      clickedBtn.classList.add('celebrate');     // радостная анимация успеха
    } else {
      restartAnimation(clickedBtn, 'shake');     // дерганая анимация ошибки
    }

    const t = texts[locale];
    const link = current.biasId
      ? `<div class="mt-2"><a href="bias.html?biasId=${current.biasId}" class="link-primary">${t.linkToBias}</a></div>`
      : '';
    const explanationText = current.explanation
      ? `<div><strong>${t.explanation}:</strong> ${current.explanation}</div>`
      : '';
    explanationEl.innerHTML = explanationText + link;
    explanationEl.classList.remove('d-none');
    restartAnimation(explanationEl, 'fade-in');

    nextBtn.classList.remove('d-none');
    restartAnimation(nextBtn, 'fade-in');
  }


  nextBtn.addEventListener('click', showQuestion);

  getBiases()
    .then(data => {
      biases = data;
      buildQuestions(data);
      if (questions.length) showQuestion();
      else questionText.textContent = texts[locale].loadError;
    })
    .catch(() => { questionText.textContent = texts[locale].loadError; });
</script>

</body>
</html>
